## Домашнее задание к занятию 6. «Troubleshooting» - Нечаев Владимир

<details>
<summary>Задача 1</summary>
  
> Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).
>
> Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD-операция в MongoDB и её 
> нужно прервать. 
>
> Вы как инженер поддержки решили произвести эту операцию:
>
> - напишите список операций, которые вы будете производить для остановки запроса пользователя;
> - предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB.
  
  </details>

#### Ответ:

> - список операций, которые буду производить для остановки запроса пользователя:

найду запрос

```js
db.currentOp(
   {
     "active" : true,
     "$ownOps": true,
     "secs_running" : { "$gt" : 180 }
   }
)
```
[Завершу принудительно](https://docs.mongodb.com/manual/tutorial/terminate-running-operations/#killop)
   ```js
   db.killOp(opid)
   ```
> - вариант решения проблемы с долгими (зависающими) запросами в MongoDB:
   
   Использовать метод [`maxTimeMS()`](https://docs.mongodb.com/manual/tutorial/terminate-running-operations/#maxtimems)
   
 <details>
<summary>Задача 2</summary>
  
> Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
> Причём отношение количества записанных key-value-значений к количеству истёкших значений есть величина постоянная и
> увеличивается пропорционально количеству реплик сервиса. 
>
> При масштабировании сервиса до N реплик вы увидели, что:
>
> - сначала происходит рост отношения записанных значений к истекшим,
> - Redis блокирует операции записи.
>
> Как вы думаете, в чём может быть проблема?
  
  </details>

#### Ответ:

Скорее всего проблема в ключах, срок действия которых истекает в одну и ту же секунду, и они составляют не менее 25% текущей совокупности ключей 
с установленным сроком действия, что и приводит к блокировке.

<details>
<summary>Задача 3</summary>
  
> Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей в таблицах базы
> пользователи начали жаловаться на ошибки вида:
> ```python
> InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
> ```
>
> Как вы думаете, почему это начало происходить и как локализовать проблему?
>
> Какие пути решения этой проблемы вы можете предложить?
  
  </details>

#### Ответ:

Скорее всего дело в большой тоаблице, для локализации проблемы необходимо проанализировать логи 
([slow_query_log](https://dev.mysql.com/_doc_/refman/8.0/en/server-system-variables.html#sysvar_slow_query_log))
и можно попробовать увеличить `net_read_timeout`, `connect_timeout` `wait_timeout`, `max_allowed_packet`, `net_write_timeout` 

<details>
<summary>Задача 4</summary>

> Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
> большим объёмом данных лучше, чем MySQL.
>
> После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:
>
> `postmaster invoked oom-killer`
>
> Как вы думаете, что происходит?
>
> Как бы вы решили эту проблему?
  
</details>

#### Ответ:

PostgreSQL не хватает памяти. Можно попробовать настроить параметры, регулирующие использование ресурсов:
`max_connections`, `effective_cache_size`, `shared_buffer`, `work_mem`, `maintenance_work_mem`.
